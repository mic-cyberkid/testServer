      # 1. Start server in background
      - name: Start HTTP Server in background
        working-directory: unzipped
        shell: pwsh
        run: |
          $job = Start-Job -ScriptBlock {
            .\PhysicsChatbotServer.exe
          }
          echo "SERVER_JOB_ID=$($job.Id)" >> $env:GITHUB_ENV
          Write-Host "Server started in background"

      # 2. Wait for port 8000
      - name: Wait for server to be ready
        shell: pwsh
        run: |
          $timeout = 60
          $elapsed = 0
          while ($elapsed -lt $timeout) {
            try {
              $result = Test-NetConnection -ComputerName localhost -Port 8000 -InformationLevel Quiet -WarningAction SilentlyContinue
              if ($result) {
                Write-Host "Server is ready on port 8000"
                exit 0
              }
            } catch {}
            Start-Sleep -Seconds 2
            $elapsed += 2
          }
          Write-Error "Server failed to start on port 8000"
          exit 1

      # 3. Setup ngrok
      - name: Setup ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip -UseBasicParsing
          Expand-Archive ngrok.zip -DestinationPath . -Force
          .\ngrok.exe authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      # 4. Start ngrok
      - name: Start ngrok tunnel
        shell: pwsh
        run: |
          Start-Job -ScriptBlock { .\ngrok.exe http 8000 --log=stdout } | Out-Null
          Write-Host "Waiting for ngrok..."
          $attempt = 0
          $publicUrl = $null
          while ($attempt -lt 20 -and -not $publicUrl) {
            $attempt++
            Start-Sleep -Seconds 3
            try {
              $tunnels = Invoke-RestMethod "http://localhost:4040/api/tunnels"
              if ($tunnels.tunnels.Count -gt 0) {
                $publicUrl = $tunnels.tunnels[0].public_url
              }
            } catch {}
          }
          if (!$publicUrl) { Write-Error "ngrok failed"; exit 1 }
          echo "NGROK_URL=$publicUrl" >> $env:GITHUB_ENV
          Write-Host "LIVE: $publicUrl"

      # 5. KEEP ALIVE
      - name: Keep tunnel alive
        run: |
          Write-Host "Your Physics Chatbot is LIVE at: ${{ env.NGROK_URL }}"
          Write-Host "Keep this tab open. Job ends in 1 hour (or cancel manually)"
          Start-Sleep -Seconds 3600
