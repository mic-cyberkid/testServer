name: Windows Download, Model Fetch, Test & ngrok Tunnel

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install requirements if present
        run: |
          if (Test-Path requirements.txt) { pip install -r requirements.txt }
          pip install requests tqdm pytest httpx

      - name: Download Google Drive ZIP
        run: python download.py

      - name: Verify ZIP downloaded
        run: dir PhysicsChatbotServer-Windows.zip

      - name: Extract ZIP
        run: Expand-Archive -LiteralPath PhysicsChatbotServer-Windows.zip -DestinationPath unzipped -Force

      - name: Download Qwen Model into models folder
        working-directory: unzipped/models
        run: |
          curl -L "https://huggingface.co/Qwen/Qwen3-0.6B-GGUF/resolve/main/Qwen3-0.6B-Q8_0.gguf?download=true" -o PhysicsChatbot.gguf

      - name: Show downloaded model
        working-directory: unzipped/models
        run: dir

      # ──────────────────────────────────────────────────────────────
      # 2. Download & Start ngrok
      # ──────────────────────────────────────────────────────────────
      - name: Setup ngrok
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip" -OutFile ngrok.zip -UseBasicParsing
          Expand-Archive ngrok.zip -DestinationPath . -Force
          .\ngrok.exe authtoken ${{ secrets.NGROK_AUTHTOKEN }}

      - name: Start ngrok tunnel
        shell: pwsh
        run: |
          # Start ngrok in background (tunnels port 8000)
          Start-Job -ScriptBlock { .\ngrok.exe http 8000 --log=stdout } | Out-Null
          Write-Host "ngrok tunnel starting..."

          # Wait for ngrok API and extract public URL
          $maxAttempts = 20
          $attempt = 0
          $publicUrl = $null

          while ($attempt -lt $maxAttempts -and -not $publicUrl) {
            $attempt++
            Start-Sleep -Seconds 5
            try {
              $tunnels = Invoke-RestMethod "http://localhost:4040/api/tunnels" -TimeoutSec 5
              if ($tunnels.tunnels.Count -gt 0) {
                $publicUrl = $tunnels.tunnels[0].public_url
              }
            } catch { }
          }

          if (-not $publicUrl) {
            Write-Error "Failed to get ngrok public URL"
            exit 1
          }

          echo "NGROK_URL=$publicUrl" >> $env:GITHUB_ENV
          Write-Host "Public ngrok URL: $publicUrl"

      # ──────────────────────────────────────────────────────────────
      # 1. Start the server (background)
      # ──────────────────────────────────────────────────────────────
      - name: Start HTTP Server in background
        id: server
        working-directory: unzipped
        shell: pwsh
        run: |
          $proc = Start-Process -FilePath "PhysicsChatbotServer.exe" -PassThru -NoNewWindow
          echo "SERVER_PID=$($proc.Id)" >> $env:GITHUB_ENV
          Write-Host "Server started with PID: $($proc.Id)"
          Start-Sleep -Seconds 50

      
      # ──────────────────────────────────────────────────────────────
      # 3. Run test script against public URL
      # ──────────────────────────────────────────────────────────────
      - name: Run Python test script (via ngrok)
        env:
          SERVER_URL: ${{ env.NGROK_URL }}
        shell: pwsh
        run: |
          Write-Host "Testing against: $env:SERVER_URL"
          python test_all.py

      # ──────────────────────────────────────────────────────────────
      # 4. Cleanup
      # ──────────────────────────────────────────────────────────────
      - name: Cleanup (server + ngrok)
        if: always()
        shell: pwsh
        run: |
          # Stop server
          if ($env:SERVER_PID) {
            Get-Process -Id $env:SERVER_PID -ErrorAction SilentlyContinue | Stop-Process -Force
          }

          # Stop ngrok
          Get-Process -Name "ngrok" -ErrorAction SilentlyContinue | Stop-Process -Force
          Get-Job | Stop-Job -Force
          Get-Job | Remove-Job -Force

          Write-Host "Cleanup complete."
